/**
 * modelFactory makes working with RESTful APIs in AngularJS easy
 * @version v0.0.1 - 2014-11-14
 * @link https://github.com/phxdatasec/modelFactory
 * @author Austin McDaniel <amcdaniel2@gmail.com>
 * @license MIT License, http://www.opensource.org/licenses/MIT
 */
!function(a,b){"use strict";var c=a.module("modelFactory",[]),d=a.forEach,e=a.extend,f=a.copy,g=["$$array","$save","$destroy","$pending","$revert","$diff","$extend"],h=["actions","instance","list","defaults","pk","stripTrailingSlashes","map"],i=function j(b){return d(arguments,function(c){c!==b&&d(c,function(c,d){-1===g.indexOf(d)&&(b[d]&&a.isObject(b[d])?j(b[d],c):a.isFunction(b[d])||(b[d]=c))})}),b};c.factory("$modelFactory",function(c,j,k,l){function m(k,m){function o(a){a.forEach(function(c,d){if(null!==c&&c!==b){var e=c.constructor===p?c:new p(c);e.$$array=a,a[d]=e}});var c=a.push;return a.push=function(b){b.constructor===p&&(b.$$array=a),c.apply(a,arguments)},m.list&&e(a,m.list),a}function p(a){var c,g=this;a===b&&(a={}),d(m.defaults,function(c,d){a[d]===b&&(a[d]="function"==typeof c?c(a):c)}),d(m.map,function(b,c){typeof b===p||typeof b===o?a[c]=new b(a[c]):"function"==typeof b?a[c]=b(a[c],a):(a[c]=a[c],delete a[c])}),d(m.actions,function(a,b){"$"===b[0]&&(g[b]=function(){return p.$buildRequest(b,a,g)})}),e(g,a),e(g,f(m.instance)),g.$save=function(){var a=p[g[m.pk]?"update":"post"](g);return g.$pending=!0,a.then(function(a){g.$pending=!1,i(g,a)}),a},g.$destroy=function(){var a=p.delete(g);return g.$pending=!0,a.then(function(){g.$pending=!1;var a=g.$$array;a&&a.splice(a.indexOf(g),1)}),a},g.$diff=function(){return DeepDiff.deep(c,g,function(a,b){return"$"===b[0]})},g.$revert=function(){return g.$extend(c)},g.$extend=function(a){return i(g,a),g},c=f(a)}var q={};return m=i({},f(n),m),p.$cache=l(k),d(m.actions,function(a,b){"base"!==b&&"$"!==b[0]&&(p[b]=function(){var c=Array.prototype.slice.call(arguments);return p.$buildRequest.apply(this,[b,a].concat(c))})}),p.$buildRequest=function(b,c,d,g){var h=f(m.actions.base);e(h,f(c)),h.cache===!0&&(h.cache=p.$cache);var i="";if(h.override)i=h.url;else if(i=k,h.url&&(i+="/"+h.url),("get"===b||"post"===b||"update"===b||"delete"===b)&&(i+="/{"+m.pk+"}"),"GET"===h.method&&(a.isString(d)||a.isNumber("number"))){var j={};j[m.pk]=d,d=j,g&&(d.param=g,i+="{?param*}")}else"GET"===h.method&&a.isObject(d)&&(d={param:d},i+="{?param*}");return h.url=p.$url(i,d),h.data=d,p.$call(h)},p.$call=function(a){if(q[a.url])return q[a.url];var d=j.defer();return q[a.url]=d.promise,a.data=f(a.data),a.beforeRequest&&a.beforeRequest(a),a.data=p.$strip(a.data),c(a).success(function(c){a.afterRequest&&a.afterRequest(c),a.invalidateCache&&p.$cache.removeAll(),d.resolve(a.wrap?a.isArray?new p.List(c):new p(c):c),q[a.url]=b}).error(function(c){q[a.url]=b,d.reject(c)}),d.promise},p.$url=function(a,b){var c=new UriTemplate(a||k).fillFromObject(b||{});return m.stripTrailing&&(c=c.replace(/\/+$/,"")||"/"),c},p.$strip=function(a){return a&&"object"==typeof a&&d(a,function(b,c){g.indexOf(c)>-1&&delete a[c]}),a},d(m,function(a,b){-1===h.indexOf(b)&&(p[b]=a)}),p.List=o,p}var n={pk:"id",stripTrailingSlashes:!0,defaults:{},map:{},actions:{base:{wrap:!0,beforeRequest:b,afterRequest:b,cache:!1},get:{method:"GET"},query:{method:"GET",isArray:!0},post:{method:"POST",invalidateCache:!0},update:{method:"PUT",invalidateCache:!0},"delete":{method:"DELETE",invalidateCache:!0}},instance:{},list:{}};return m})}(angular);